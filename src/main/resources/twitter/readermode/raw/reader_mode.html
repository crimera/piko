<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Title</title>

	<style>
		:root {
			--bg-body: white;
			--text: black;
			--border: rgba(0, 0, 0, 0.08);
			--primary-color: #1DA1F2;
		}

		body.lights-out {
			--bg-body: black;
			--text: white;
			--border: rgba(255, 255, 255, 0.2);
		}

		/* Make the document fill its parent/viewport */
		html {
			margin: 0;
			padding: 0;
		}

		body {
			margin: 0;
			padding: 15px;
			background-color: var(--bg-body);
			color: var(--text);
			font-size: 18px;
		}

		a {
			color: var(--primary-color);
		}
		
	.post-container > div:not(:last-child)  {
    border-bottom: 1px solid var(--border); /* Uses the same border color */
  }

		.profile-container {
			display: flex;
			flex-basis: column;
			align-items: center;
		}

		.profile-image {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			overflow: hidden;
			margin-right: 10px;
		}

		.profile-name {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
		}

		.profile-handle {
			font-size: 14px;
			margin: 0;
		}
	</style>
</head>

<body>

	<p style="padding: 0; margin: 0;" id="result"></p>

	<div class="profile-container">
		<div class="profile-image">
			<img id="profile-image" alt="Profile Image" width="48" height="48">
		</div>
		<div class="profile-info">
			<p id="name" class="profile-name">
				Gareth Wild
			</p>
			<p id="username" class="profile-handle">
				@GarethWild
			</p>
		</div>
	</div>

	<div class="post-container">
	</div>

	<script>
		// Helpers
		const android = window.Android

		const resultElement = document.getElementById("result");

		const primaryColor = android.getColor("system_accent1_200", "android")

		function getThreadInfo() {
			if (android) {
				const jsonString = android.getThreadInfo();
				try {
					// Parse the JSON string into an object
					return JSON.parse(jsonString);
				} catch (e) {
					android.log("Error parsing JSON: " + e.message);
				}
			} else {
				resultElement.innerText += "AndroidInterface not available";
			}
		}

		function createPhoto(photo, style) {
			return `
<img src="${photo.src}" style="width: 100%; height: auto; ${style}">
            `
		}
		
		function addToResult(message) {
		  resultElement.innerText += `${message}`;
		}

		function createVideo(video, medias, style) {
			return medias.map((media, index) => {
			 
			  const url = media.sources[0].url
			  const posterAttr = media.type == "video" ? `poster="${video.posterUrl}"` : ""
			  
				return `
          <video 
            controls
           style="width: 100%; height: auto; ${style};"
            ${posterAttr}
            >
            <source src="${url}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
				`;
			}).join('\n');
		}
		
		function createQuote(quote) {
		  const textOnlyMode = false
		  
		  const mediaStyles = "border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"
		  
		  const profile = `
		  <div class="profile-container" style="display: flex; flex-direction: row; gap: 5px;">
		<div class="profile-image" style="width: 20px; height: 20px; margin-right: 0;">
			<img src="${quote.author.profileImageUrl}" alt="Profile Image" width="20" height="20">
		</div>

			<p class="profile-name">
				${quote.author.name}
			</p>
			<p class="profile-handle">
				@${quote.author.username}
			</p>

	</div>
		  `
		  
		  return `
		    <div style="display: flex; flex-direction: column; gap: 10px; border: 1px solid var(--border); border-radius: 15px; padding-top: 10px; margin-bottom: 10px;">
		      <div style="padding-right: 10px; padding-left: 10px;">
		        ${profile}
		        <p style="margin-top: 10px; margin-bottom: 10px;">${quote.text}</p>
		      </div>
		      ${quote.photos && !textOnlyMode ? quote.photos.map(photo => createPhoto(photo, mediaStyles)).join(' ') : ''}
		      ${quote.media && !textOnlyMode ? createVideo(quote.video, quote.media, mediaStyles) : ''}
		    </div>
		  `
		}

		function createPostElement(post) {

			let text = post.text
			const photos = post.photos
			const urls = post.urls
			const video = post.video
			const media = post.media

			// TODO: implement the function to get the settings
			const textOnlyMode = false

			text = text.replaceAll("\n", "<br>")

			if (photos) {
				photos.forEach(photo => {
					text = text.replace(photo.url, "")
				})
			}

			if (urls) {
				urls.forEach(url => {
					text = text.replace(url.url, `<a href="${url.expandedUrl}">${url.displayUrl}</a>`)
				})
			}

			if (post.hashtags) {
				post.hashtags.forEach(hashtag => {
					const start = hashtag.indices[0];
					const end = hashtag.indices[1];
					const link = `<a href="https://x.com/hashtag/${hashtag.text}">#${hashtag.text}</a>`;
					text = text.substring(0, start) + link + text.substring(end);
				});
			}
			
			const mediaStyles = "border-radius: 15px; margin-bottom: 10px;"

			return `
				<div>
          <p>${text}</p>
${photos && !textOnlyMode ? photos.map(photo => createPhoto(photo, mediaStyles)).join(' ') : ''}
${media && !textOnlyMode ? createVideo(video, media, mediaStyles) : ''}
${post.quoted ? createQuote(post.quoted) : ''}
				</div>
			  `;
		}

		// Main

		if (android.getTheme() == 1) {
			document.body.className = "lights-out"
		}

		const threadInfo = getThreadInfo()

		// use dynamic color
		document.documentElement.style.setProperty('--primary-color', primaryColor);

		//posts
		const posts = threadInfo.thread.tweets
		posts.forEach(element => {
			document.querySelector(".post-container").innerHTML += createPostElement(element);
		});

		// profile
		document.getElementById("name").innerText = threadInfo.thread.author.name
		document.getElementById("username").innerText = "@" + threadInfo.thread.author.username
		document.getElementById("profile-image").src = threadInfo.thread.author.profileImageUrl
	</script>
</body>

</html>
